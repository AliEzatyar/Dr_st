{% extends 'main__/base.html' %}
{% load static %}
{% block style %}
    <link type="text/css" rel="stylesheet" href="{% static "css/bgt/bgt.css" %}">
{% endblock %}
{% block domready %}
{#    <script>#}
        document.getElementById('id_bg_price').addEventListener('keyup', function (e) {
            var total = document.getElementById('id_total');
            var pricee = document.getElementById('id_bg_price')
            var amount = document.getElementById('id_amount')
            total.value = Number(pricee.value) * Number(amount.value)
        })
        <!-- filling drugname selector-->
        var name_selector = document.getElementById('id_name')
        name_selector.innerHTML =
            `
    <option>انتخاب دارو</option>`
        name_selector.innerHTML += `
    {% for drug in drugs %}
        <option class="selector_option">
            {{ drug }}
        </option>
    {% endfor %}
    `
        <!-- filling company selector-->
        var company_selector = document.getElementById("id_company")
        name_selector.addEventListener('change', function (e) {
            company_selector.innerHTML = `
                    <option>انتخاب شرکت</option>`
            const drugName = e.target.value
            const get_cmp_url = "{% url 'main:get_companies' %}"
            fetch(get_cmp_url + "?drug_name=" + drugName).then(response => response.json()).then(list => list.forEach(company => {
                function formatter(html, ...args) {
                    return html.reduce((acc, curr, i) => acc + args[i - 1] + curr);
                }

                company_selector.innerHTML += formatter`
                            <option>
                                ${company}
                            </option>
                            `


            }))
        })

        <!--new_drug button-->
        function new_drug() {
            document.querySelector(".name").innerHTML = `
    <label id="name_label">
        نام دارو:
    </label>
    <br>
    <input type="text" id="id_name" name="name">
    `
            document.querySelector(".company").innerHTML = `
    <label>
        شرکت دارو:
    </label>
    <input type="text" id="id_company" name="company">
    `
            document.getElementById("new_drug").remove()
            document.getElementById("img-preview").src = "{% static 'UsedPhoto/BedonAks.jpg' %}"
        }

        document.getElementById("new_drug").onclick = new_drug

        <!--making an image preview-->
        var img_preview = document.getElementById("img-preview")
        var file_input = document.getElementById("id_photo")

        <!--when drug exists before-->
        company_selector.addEventListener("change", function (e) {
            var new_drug = document.getElementById("new_drug")
            if (new_drug === null) {
                console.log('')
            } else {
                new_drug.remove()
            }
            const company = e.target.value
            const drug_name = name_selector.value
            photo_url = "{{ media_url }}" + drug_name + "___" + company + ".jpg"
            fetch(photo_url).then(response => response.text()).then(html => {
                if (html.search("Page not found") == -1) {
                    img_preview.src = photo_url

                } else {
                    img_preview.src = "{% static 'UsedPhoto/BedonAks.jpg' %}"

                }
            })
        })
        <!--when new drug is being added -->
        file_input.addEventListener('change', function () {
            window.alert("sfdsdf")
            // Check if a file is selected
            if (file_input.files && file_input.files[0]) {
                // Create a FileReader object
                const reader = new FileReader();

                // Set a callback function to execute when the image is loaded
                reader.onload = function (e) {
                    // Set the image source to the loaded data
                    img_preview.src = e.target.result;
                };

                // Read the selected file as a URL
                reader.readAsDataURL(file_input.files[0]);
                x = reader.readAsDataURL(file_input.files[0])
                window.alert(x)
            }
        });

        <!--showing errors-->
        {% if errors %}
            var company = document.getElementById('id_company')
            var name = document.getElementById('id_name')
            name.value = "{{ form.name.value }}"
            company.innerHTML = `
                <option>{{ form.company.value }}</option>`
            <!--sending a programmatic event to set the photo-->
            {#company.dispatchEvent(new Event("change"))#} <!--active it if you want-->
            name.dispatchEvent(new Event("change"))
            var date = document.getElementById('id_date')
            date.value = `{{ form.date.value }}`
            var photo = document.getElementById("id_photo")
            photo.src = "{% static 'UsedPhoto/BedonAks.jpg' %}"
        {% endif %}
{#    </script>#}
{% endblock %}
{% block title %}خرید{% endblock %}
{% block content %}
    <h1 id="buy_title">خرید دارو</h1>
    <form id='forma' enctype="multipart/form-data" method="post" action="{% url 'main:bgt' %}">
        <div id="buy_form_fields">
            <div class="pair">
                <div id="label_input" class="name">
                    <label id="name_label">
                        نام دارو:
                    </label>
                    <button type="button" onclick='' id="new_drug">+
                    </button>
                    <br>
                    <select id="id_name" name="name" class="selectors">
                        <option>انتخاب دارو</option>
                    </select>
                </div>

                <div id="label_input" class="company">
                    <label>
                        شرکت دارو:
                    </label>
                    <br>
                    <select id="id_company" name="company" class="selectors">
                        <option>انتخاب شرکت</option>
                    </select>
                </div>

            </div>
            <br>
            <div class="pair">
                <div id="label_input">
                    <label>
                        مقدار دارو:
                    </label>
                    <br>
                    {{ form.amount }}
                </div>
                <div id="label_input">
                    <label>
                        قیمت خرید:
                    </label>
                    {{ form.bg_price }}
                </div>

            </div>

            <br>
            <div class="pair">
                <div id="label_input">
                    <label>
                        تاریخ خرید:
                    </label>
                    {{ form.date }}
                    <script src="{% static 'js/jdatepicker.js' %}">
                        jDatePicker("id_date")
                    </script>
                </div>
                <div id="label_input">
                    <label>
                        بیل نمبر:
                    </label>
                    <br>
                    {{ form.bgt_bill }}
                </div>
            </div>
            <br>
            <div class="pair">
                <div id="label_input">
                    <label>
                        واحد پول:
                    </label>
                    <br>
                    <select class="selectors" name="currency">
                        <option>AFS</option>
                        <option>USD</option>
                        <option>KLD</option>
                    </select>
                </div>
                <div id="label_input">
                    <label>
                        مجموع:
                    </label>
                    <br>
                    {{ form.total }}
                </div>
            </div>
            <input id="submitt" type="submit" value="ثبت خرید">
            <div id="photo">
                <label>
                    عکس دارو:
                </label>
                <br>
                {{ form.photo }}
            </div>
            {% csrf_token %}
        </div>
    </form>
    <img id="img-preview" style="" src="{% static 'UsedPhoto/BedonAks.jpg' %}">
    {% if errors %}
        <ul id="errors">
            خطا!
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}